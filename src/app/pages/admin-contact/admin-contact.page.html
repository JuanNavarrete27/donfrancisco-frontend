<div class="admin-contact" [class.header-shine]="headerShine">

  <!-- Fondo -->
  <div class="bg-grain"></div>
  <div class="bg-glow"></div>

  <!-- TOASTS -->
  <div class="toast-stack" aria-live="polite" aria-atomic="true">
    <div
      class="toast"
      *ngFor="let t of toasts"
      [class.toast--ok]="t.type === 'ok'"
      [class.toast--warn]="t.type === 'warn'"
      [class.toast--error]="t.type === 'error'"
    >
      <div class="toast__dot"></div>

      <div class="toast__body">
        <div class="toast__title">{{ t.title }}</div>
        <div class="toast__msg" *ngIf="t.msg">{{ t.msg }}</div>
      </div>

      <button
        class="toast__x"
        type="button"
        (click)="cerrarToast(t.id)"
        aria-label="Cerrar notificaciÃ³n"
      >
        âœ•
      </button>
    </div>
  </div>

  <!-- HEADER -->
  <section class="header">
    <div class="header__left">
      <h1 class="title">BuzÃ³n de contacto</h1>
      <p class="subtitle">Mensajes recibidos desde el formulario de contacto.</p>
    </div>

    <div class="header__right">
      <div class="metrics">
        <div class="metric">
          <div class="metric__label">Activos</div>
          <div class="metric__value">{{ counts.activos }}</div>
        </div>

        <div class="metric">
          <div class="metric__label">No leÃ­dos</div>
          <div
            class="metric__value badge"
            [class.badge--pulse]="badgePulse"
            [class.badge--zero]="counts.no_leidos === 0"
          >
            {{ counts.no_leidos }}
          </div>
        </div>

        <div class="metric">
          <div class="metric__label">Pendientes</div>
          <div class="metric__value">{{ counts.pendientes_respuesta }}</div>
        </div>
      </div>

      <div class="actions">
        <button
          type="button"
          class="btn btn--ghost"
          (click)="refreshAll(false)"
          [disabled]="loading || loadingCounts"
        >
          {{ (loading || loadingCounts) ? 'Actualizando...' : 'Actualizar' }}
        </button>

        <button
          type="button"
          class="btn btn--gold"
          (click)="toggleUnreadOnly()"
        >
          {{ unreadOnly ? 'Ver todos' : 'Solo no leÃ­dos' }}
        </button>
      </div>
    </div>
  </section>

  <!-- TOOLBAR -->
  <section class="toolbar">
    <div class="search">
      <span class="search__icon">âŒ•</span>
      <input
        type="text"
        class="search__input"
        placeholder="Buscar por nombre, email o mensaje..."
        [(ngModel)]="query"
      />
      <button
        class="search__clear"
        type="button"
        *ngIf="query"
        (click)="query = ''"
        aria-label="Limpiar bÃºsqueda"
      >
        âœ•
      </button>
    </div>

    <div class="pager">
      <button
        type="button"
        class="btn btn--mini"
        (click)="prevPage()"
        [disabled]="offset === 0 || loading"
      >
        â—€
      </button>

      <div class="pager__text">
        {{ offset + 1 }}â€“{{ offset + pageSize }}
      </div>

      <button
        type="button"
        class="btn btn--mini"
        (click)="nextPage()"
        [disabled]="loading || mensajes.length < pageSize"
      >
        â–¶
      </button>
    </div>
  </section>

  <!-- ERROR -->
  <div class="state" *ngIf="error && !loading">
    <div class="state__card">
      <div class="state__title">Upsâ€¦</div>
      <div class="state__msg">{{ error }}</div>
      <button class="btn btn--gold" type="button" (click)="refreshAll(false)">
        Reintentar
      </button>
    </div>
  </div>

  <!-- LOADING -->
  <div class="state" *ngIf="loading">
    <div class="state__card state__card--loading">
      <div class="spinner"></div>
      <div class="state__msg">Cargando mensajesâ€¦</div>
    </div>
  </div>

  <!-- LIST -->
  <section class="list" *ngIf="!loading && !error">
    <div class="empty" *ngIf="mensajesFiltrados.length === 0">
      <div class="empty__title">No hay mensajes</div>
      <div class="empty__msg">ProbÃ¡ cambiar el filtro o refrescar.</div>
    </div>

    <article
      class="row"
      *ngFor="let m of mensajesFiltrados"
      [class.row--unread]="isUnread(m)"
      [class.row--confirming]="confirmDeleteId === m.id"
      [ngClass]="getRowClass(m.id)"
      (click)="openModal(m)"
    >
      <div class="row__left">
        <div class="avatar">
          {{ (m.nombre || '?').slice(0,1).toUpperCase() }}
        </div>

        <div class="meta">
          <div class="meta__top">
            <div class="name">{{ m.nombre }}</div>

            <span class="chip chip--unread" *ngIf="isUnread(m)">Nuevo</span>
            <span class="chip chip--read" *ngIf="!isUnread(m)">LeÃ­do</span>
          </div>

          <div class="meta__mid">
            <div class="email">{{ m.email }}</div>
            <div class="date">{{ fmtDate(m.created_at) }}</div>
          </div>

          <div class="preview">
            {{ m.mensaje }}
          </div>
        </div>
      </div>

      <div class="row__right" (click)="$event.stopPropagation()">
        <button
          type="button"
          class="icon-btn"
          title="Marcar como leÃ­do"
          (click)="marcarLeido(m)"
          [disabled]="rowBusy[m.id]"
        >
          âœ“
        </button>

        <button
          type="button"
          class="icon-btn icon-btn--danger"
          title="Eliminar"
          (click)="pedirEliminar(m.id)"
          [disabled]="rowBusy[m.id]"
        >
          ðŸ—‘
        </button>
      </div>

      <!-- Confirm delete bar -->
      <div
        class="confirm"
        *ngIf="confirmDeleteId === m.id"
        (click)="$event.stopPropagation()"
      >
        <div class="confirm__text">
          Â¿Eliminar este mensaje?
        </div>

        <div class="confirm__actions">
          <button
            class="btn btn--mini btn--ghost"
            type="button"
            (click)="cancelarEliminar()"
            [disabled]="confirmDeleteBusy"
          >
            Cancelar
          </button>

          <button
            class="btn btn--mini btn--danger"
            type="button"
            (click)="confirmarEliminar()"
            [disabled]="confirmDeleteBusy"
          >
            {{ confirmDeleteBusy ? 'Eliminandoâ€¦' : 'Eliminar' }}
          </button>
        </div>
      </div>
    </article>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer__hint">
    hacÃ© click en un mensaje para verlo completo.
    </div>
  </footer>

</div>

<!-- ============================================================
     MODAL â€” ESTILO NOTICIAS
============================================================ -->

<!-- OVERLAY -->
<div
  class="modal-overlay"
  *ngIf="modalOpen"
  (click)="closeModal()"
></div>

<!-- WRAPPER -->
<div class="modal-wrapper" *ngIf="modalOpen">

  <div class="modal-content" (click)="$event.stopPropagation()">

    <button class="modal-close" (click)="closeModal()">âœ•</button>

    <h2 class="modal-title">
      {{ modalMensaje?.nombre }}
    </h2>

    <p class="modal-fecha">
      {{ modalMensaje?.email }} Â· {{ fmtDate(modalMensaje?.created_at || '') }}
    </p>

    <div class="modal-scroll">
      <p class="modal-descripcion">
        {{ modalMensaje?.mensaje }}
      </p>
    </div>

  </div>
</div>
