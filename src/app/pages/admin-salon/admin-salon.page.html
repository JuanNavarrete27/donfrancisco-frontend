<!-- admin-salon.page.html -->
<div class="admin-salon" [class.header-shine]="headerShine">

  <div class="bg-grain"></div>
  <div class="bg-glow"></div>

  <!-- TOASTS -->
  <div class="toast-stack" aria-live="polite" aria-atomic="true">
    <div
      class="toast"
      *ngFor="let t of toasts"
      [class.toast--ok]="t.type === 'ok'"
      [class.toast--warn]="t.type === 'warn'"
      [class.toast--error]="t.type === 'error'"
    >
      <div class="toast__dot"></div>

      <div class="toast__body">
        <div class="toast__title">{{ t.title }}</div>
        <div class="toast__msg" *ngIf="t.msg">{{ t.msg }}</div>
      </div>

      <button
        class="toast__x"
        type="button"
        (click)="cerrarToast(t.id)"
        aria-label="Cerrar notificaci√≥n"
      >
        ‚úï
      </button>
    </div>
  </div>

  <!-- HEADER -->
  <section class="header">
    <div class="header__left">
      <h1 class="title">Buz√≥n del sal√≥n</h1>
      <p class="subtitle">
        Solicitudes de reserva (pendientes, aprobadas y rechazadas). Al aprobar, se bloquean las horas.
      </p>
    </div>

    <div class="header__right">
      <div class="tabs" role="tablist" aria-label="Estados de solicitudes">

        <!-- ‚úÖ NUEVO: TODAS -->
        <button
          type="button"
          class="tab"
          [class.tab--active]="estado === 'all'"
          (click)="setEstado('all')"
          role="tab"
          [attr.aria-selected]="estado === 'all'"
        >
          Todas
        </button>

        <button
          type="button"
          class="tab"
          [class.tab--active]="estado === 'pending'"
          (click)="setEstado('pending')"
          role="tab"
          [attr.aria-selected]="estado === 'pending'"
        >
          Pendientes

          <span
            *ngIf="pendingCount > 0"
            class="tab__badge"
            [class.tab__badge--pulse]="badgePulse"
          >
            {{ pendingCount }}
          </span>
        </button>

        <button
          type="button"
          class="tab"
          [class.tab--active]="estado === 'approved'"
          (click)="setEstado('approved')"
          role="tab"
          [attr.aria-selected]="estado === 'approved'"
        >
          Aprobadas
        </button>

        <button
          type="button"
          class="tab"
          [class.tab--active]="estado === 'rejected'"
          (click)="setEstado('rejected')"
          role="tab"
          [attr.aria-selected]="estado === 'rejected'"
        >
          Rechazadas
        </button>
      </div>

      <div class="actions">
        <button
          type="button"
          class="btn btn--ghost"
          (click)="refresh(false)"
          [disabled]="loading"
        >
          {{ loading ? 'Actualizando...' : 'Actualizar' }}
        </button>

        <button
          type="button"
          class="btn btn--gold"
          (click)="refresh(true)"
          [disabled]="loading"
        >
          Recargar
        </button>
      </div>
    </div>
  </section>

  <!-- TOOLBAR -->
  <section class="toolbar">
    <div class="search">
      <span class="search__icon">‚åï</span>
      <input
        type="text"
        class="search__input"
        placeholder="Buscar por nombre, email, fecha, tel√©fono, mensaje..."
        [(ngModel)]="query"
      />
      <button
        class="search__clear"
        type="button"
        *ngIf="query"
        (click)="query = ''"
        aria-label="Limpiar b√∫squeda"
      >
        ‚úï
      </button>
    </div>

    <div class="pager">
      <button
        type="button"
        class="btn btn--mini"
        (click)="prevPage()"
        [disabled]="offset === 0 || loading"
      >
        ‚óÄ
      </button>

      <div class="pager__text">
        {{ offset + 1 }}‚Äì{{ offset + pageSize }}
      </div>

      <button
        type="button"
        class="btn btn--mini"
        (click)="nextPage()"
        [disabled]="loading || solicitudes.length < pageSize"
      >
        ‚ñ∂
      </button>
    </div>
  </section>

  <!-- ERROR -->
  <div class="state" *ngIf="error && !loading">
    <div class="state__card">
      <div class="state__title">Ups‚Ä¶</div>
      <div class="state__msg">{{ error }}</div>
      <button class="btn btn--gold" type="button" (click)="refresh(false)">
        Reintentar
      </button>
    </div>
  </div>

  <!-- LOADING -->
  <div class="state" *ngIf="loading">
    <div class="state__card state__card--loading">
      <div class="spinner"></div>
      <div class="state__msg">Cargando solicitudes‚Ä¶</div>
    </div>
  </div>

  <!-- LIST -->
  <section class="list" *ngIf="!loading && !error">
    <div class="empty" *ngIf="solicitudesFiltradas.length === 0">
      <div class="empty__title">No hay solicitudes</div>
      <div class="empty__msg">Prob√° cambiar el estado o refrescar.</div>
    </div>

    <article
      class="row"
      *ngFor="let s of solicitudesFiltradas"
      [ngClass]="getRowClass(s.id, s.estado)"
      [class.row--confirming]="confirmActionId === s.id"
      (click)="openModal(s)"
    >
      <div class="row__left">
        <div class="avatar">
          {{ (s.nombre || '?').slice(0,1).toUpperCase() }}
        </div>

        <div class="meta">
          <div class="meta__top">
            <div class="name">{{ s.nombre }} {{ s.apellido }}</div>

            <span class="chip chip--pending" *ngIf="s.estado === 'pending'">Pending</span>
            <span class="chip chip--approved" *ngIf="s.estado === 'approved'">Approved</span>
            <span class="chip chip--rejected" *ngIf="s.estado === 'rejected'">Rejected</span>
          </div>

          <div class="meta__mid">
            <div class="email">{{ s.email }}</div>
            <div class="date">{{ fmtDate(s.created_at) }}</div>
          </div>

          <div class="meta__mid">
            <div class="pill">
              {{ fmtFecha((s.fecha || '').slice(0,10)) }}
            </div>

            <div class="pill pill--gold">
              {{ (s.hora_inicio || '').slice(0,5) }} ‚Üí {{ (s.hora_fin || '').slice(0,5) }}
            </div>

            <div class="pill pill--soft">
              {{ horasDeSolicitud(s).length }} h
            </div>
          </div>

          <div class="preview" *ngIf="s.mensaje">
            {{ s.mensaje }}
          </div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="row__right" (click)="$event.stopPropagation()">
        <button
          *ngIf="s.estado === 'pending'"
          type="button"
          class="icon-btn"
          title="Aprobar"
          (click)="pedirAprobar(s.id)"
          [disabled]="rowBusy[s.id]"
        >
          ‚úì
        </button>

        <button
          *ngIf="s.estado === 'pending'"
          type="button"
          class="icon-btn icon-btn--danger"
          title="Rechazar"
          (click)="pedirRechazar(s.id)"
          [disabled]="rowBusy[s.id]"
        >
          ‚úï
        </button>

        <button
          *ngIf="s.estado !== 'pending'"
          type="button"
          class="icon-btn"
          title="Ver detalle"
          (click)="openModal(s)"
        >
          üëÅ
        </button>
      </div>

      <!-- Confirm bar -->
      <div
        class="confirm"
        *ngIf="confirmActionId === s.id"
        (click)="$event.stopPropagation()"
      >
        <div class="confirm__text">
          <ng-container *ngIf="confirmActionType === 'approve'">
            ¬øAprobar y bloquear {{ horasDeSolicitud(s).length }} hora(s)?
          </ng-container>
          <ng-container *ngIf="confirmActionType === 'reject'">
            ¬øRechazar esta solicitud?
          </ng-container>
        </div>

        <div class="confirm__actions">
          <button
            class="btn btn--mini btn--ghost"
            type="button"
            (click)="cancelarAccion()"
            [disabled]="confirmActionBusy"
          >
            Cancelar
          </button>

          <button
            class="btn btn--mini"
            [class.btn--gold]="confirmActionType === 'approve'"
            [class.btn--danger]="confirmActionType === 'reject'"
            type="button"
            (click)="confirmarAccion()"
            [disabled]="confirmActionBusy"
          >
            {{ confirmActionBusy ? 'Procesando‚Ä¶' : (confirmActionType === 'approve' ? 'Aprobar' : 'Rechazar') }}
          </button>
        </div>
      </div>
    </article>
  </section>

  <footer class="footer">
    <div class="footer__hint">
      Hac√© click en una solicitud para ver el detalle completo.
    </div>
  </footer>

</div>

<!-- MODAL (igual tuyo) -->
<div class="modal-overlay" *ngIf="modalOpen" (click)="closeModal()"></div>

<div class="modal-wrapper" *ngIf="modalOpen">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeModal()">‚úï</button>

    <h2 class="modal-title">
      {{ modalSolicitud?.nombre }} {{ modalSolicitud?.apellido }}
    </h2>

    <p class="modal-fecha">
      {{ modalSolicitud?.email }} ¬∑ {{ modalSolicitud?.telefono }} ¬∑
      {{ fmtDate(modalSolicitud?.created_at || '') }}
    </p>

    <div class="modal-badges">
      <span class="chip chip--pending" *ngIf="modalSolicitud?.estado === 'pending'">Pending</span>
      <span class="chip chip--approved" *ngIf="modalSolicitud?.estado === 'approved'">Approved</span>
      <span class="chip chip--rejected" *ngIf="modalSolicitud?.estado === 'rejected'">Rejected</span>

      <span class="pill pill--gold" *ngIf="modalSolicitud">
        {{ fmtFecha((modalSolicitud.fecha || '').slice(0,10)) }} ¬∑
        {{ (modalSolicitud.hora_inicio || '').slice(0,5) }} ‚Üí {{ (modalSolicitud.hora_fin || '').slice(0,5) }}
      </span>
    </div>

    <div class="modal-grid" *ngIf="modalSolicitud">
      <div class="modal-card">
        <div class="modal-card__label">Horas solicitadas</div>
        <div class="hours">
          <span class="hour" *ngFor="let h of horasDeSolicitud(modalSolicitud)">
            {{ h }}
          </span>
        </div>
      </div>

      <div class="modal-card" *ngIf="modalSolicitud.mensaje">
        <div class="modal-card__label">Mensaje</div>
        <div class="modal-scroll">
          <p class="modal-descripcion">{{ modalSolicitud.mensaje }}</p>
        </div>
      </div>
    </div>

    <div class="modal-actions" *ngIf="modalSolicitud?.estado === 'pending'">
      <button class="btn btn--ghost" type="button" (click)="closeModal()">
        Cerrar
      </button>

      <button
        class="btn btn--danger"
        type="button"
        (click)="closeModal(); pedirRechazar(modalSolicitud!.id)"
      >
        Rechazar
      </button>

      <button
        class="btn btn--gold"
        type="button"
        (click)="closeModal(); pedirAprobar(modalSolicitud!.id)"
      >
        Aprobar
      </button>
    </div>
  </div>
</div>
